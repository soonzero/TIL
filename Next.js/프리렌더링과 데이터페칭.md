# Next.js

## Pre-rendering and Data Fetching

- Pre-rendering

  - Next.js는 기본적으로 모든 페이지를 프리렌더링한다. 즉, 클라이언트 사이드 자바스크립트로 페이지에 대한 전체 HTML을 생성하는 대신 각 페이지에 대한 HTML을 사전에 생선하기 때문에, 성능과 SEO 측면에서 더 나은 결과를 제공한다. 미리 생성된 HTML은 해당 페이지에서 필요로 하는 최소한의 자바스크립트 코드로 되어있다.

    - Hydration(수화): 페이지의 자바스크립트 코드가 실행되고 페이지를 interactive하게 만드는 것.

    <br />

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2Fa86e0ea0-d242-472f-ad9b-a14794992d19%2Fpre-rendering.png" alt="Pre-rendering(Using Next.js)" />

    - 초기 로드: 프리렌더링 된 HTML이 출력된다.

    - 수화: 리액트 컴포넌트가 초기화되고 앱이 interactive 상태가 된다.

    - 만약 `<Link />` 태그와 같이 interactive한 컴포넌트를 갖고 있다면, 해당 요소는 JS가 로드된 후에 활성화된다.

    <br />

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2Fe8d51f8a-fcb9-44b2-9017-3b98d05a0363%2Fno-pre-rendering.png" alt="No Pre-rendering(Plain React.js)" />

    <br />

    - 초기 로드: 앱이 렌더링되지 않는다.

    - 수화: 리액트 컴포넌트가 초기화되고 앱이 interactive 상태가 된다.

<br />

- Pre-rendering and Data Fetching

  - Next.js는 정적 생성과 SSR 두 가지의 프리 렌더링을 제공하고, 각 페이지에 대한 렌더링 방식을 선택할 수 있도록 했다.

  - 즉, 일부 페이지는 정적 생성 방식으로 렌더링하고, 나머지 페이지는 서버 사이드 렌더링 방식을 사용하는 '하이브리드' 앱을 만들 수 있다.

  - 둘의 차이점은 **언제** HTML이 생성되느냐이다.

    <br />

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2F53360988-f9de-4b56-acca-bc8954f705cc%2Fper-page-basis.png" alt="per page basis">

    <br />

    - Static Generation(정적 생성): HTML을 빌드 타임에 생성하는 방식이며, 생성된 HTML은 매 요청마다 재사용된다.

    <br />

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2F6a1751f2-fb56-4751-bac6-04de30189f77%2Fstatic-generation.png" alt="static generation">

    <br />

    - SSR(서버 사이드 렌더링): 요청 시에 HTML이 생성된다.

    <br />

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2Fc3c3138b-f876-458b-89ba-b704558b6dd2%2Fserver-side-rendering.png" alt="ssr">

<br />

- Static Generation

  <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2Fe91cbe06-00bf-4fb0-a684-c0993a6ec69f%2Fstatic-generation-without-data.png" alt="static generation without data">

  - without 외부 데이터

  <br />

  <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2F856aaf7a-d5f5-4842-8914-25bd060b7dda%2Fstatic-generation-with-data.png" alt="static generation without data">

  - with 외부 데이터

    - `getStaticProps`: Next.js에서 페이지 컴포넌트를 export할 때 이 async 함수도 같이 export할 수 있는데, Next.js가 빌드 타임에 이 페이지를 프리렌더링 할 때 데이터를 먼저 해결하라고 명령하는 것이라고 볼 수 있다. 그리고 `getStaticProps`는 page에서만 export될 수 있는데, 리액트는 페이지가 렌더링 되기 이전에 모든 필요한 데이터를 가지고 있어야 하기 때문이다.

      ```
      export default function Home(props) { ... }

      export async function getStaticProps() {
        const data = ...

        return {
          props: ...
        }
      }
      ```

<br />

- Fetching Data at Request Time (SSR)

  - 빌드 타임이 아닌 **사용자 요청 시 데이터를 가져온 후 데이터가 유효할 때** 화면이 보여지는 것이 좋다고 판단되면 SSR을 시도해 볼 수 있다.

  - 데이터가 포함되어 프리렌더링되므로 SEO에 좋지만, api loading 속도가 느리다면 사용자는 텅 빈 화면을 바라봐야 한다는 단점이 존재한다.

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2F4f98136b-b239-4a74-9a22-033737439b8c%2FGroup%201%20(1).png" alt="SSR with data" />

    <br />

  - `getServerSideProps`

    ```
    export async function getServerSideProps() {
      ...

      // 이 곳에 작성하는 코드는 클라이언트가 아니라 서버 쪽에서만 돌아가게 된다.
      // API KEY와 같이, 다른 사용자들에게 숨기고 싶은 것들은 이 함수 내에서 진행하면 드러날 걱정이 없다.
      // 대신 이 코드가 끝나기 전까지는 페이지에 렌더링이 일어나지 않는다.

      ...

      const { results } = await (await fetch(`...`)).json();
      return {
        props: {
          results
        }
      }
    }
    ```

<br />

- `getStaticProps`와 `getServerSideProps`의 차이점 (상세)

  - `getStaticProps`와 `getServerSideProps` 둘 다 화면이 렌더링되기 전에 데이터를 불러온다는 공통점이 있다.

  - 그렇다면 둘의 차이점에 대해서 자세히 알아보자.

    - `getStaticProps`

      - 정적 생성은 빌드할 때 데이터를 가져와서 html을 만들고, 사용자의 요청이 들어올 때마다 빌드된 html을 재사용한다.

      - 따라서 모든 사용자에게 재사용할 수 있는 **정적인 페이지**를 만들 경우에 적합한 방법이다.

      - ex. 상품 목록 페이지, 도움말 및 문서 페이지 등

    - `getServerSideProps`:

      - 요청할 때마다 html이 생성되기 때문에 데이터가 계속 업데이트 된다.

      - 따라서 데이터가 계속 바뀌어야 하고, 최신으로 업데이트된 상태를 유지해야 하는 페이지의 경우에 적합한 방법이다.

<br />

- Client-Side Rendering

  - 다른 화면을 초기에 렌더링했다가 JS코드로 데이터를 불러와서 새로 렌더링해주는 게 좋다고 판단되면, CSR을 사용할 수 있다.

  - 다만 프리렌더링된 html 페이지에 데이터가 포함되지 않기 때문에 SEO에 불리할 수 있다.

    <img src="https://velog.velcdn.com/images%2Fjaewoneee%2Fpost%2F47f01281-ff8a-429e-981d-f1a44008f4c2%2FGroup%203.png" alt="Static Generation without Data + Fetch Data on the Client-Side" />

    <br />

  - 외부 데이터를 필요로 하지 않는 페이지의 일부분을 정적으로 생성하고, 페이지가 로드될 때 클라이언트 단의 자바스크립트를 사용해서 외부 데이터를 가져오고 나머지 부분을 구현한다.

  - 사용자의 대시보드 같은 페이지에 CSR을 적용하기 적합하다.

    - 사용자의 고유 페이지이므로 데이터 업데이트가 잦아 데이터를 계속 요청해야 하고, SEO와도 전혀 관련이 없어서 프리렌더링도 필요하지 않기 때문이다.

  - api를 loading 하는 경우, 속도가 느리더라도 사용자는 텅 빈 화면을 볼 필요가 없다.

  - [SWR](https://swr.vercel.app/ko): Next.js가 만든 데이터 fetching을 위한 React Hook
